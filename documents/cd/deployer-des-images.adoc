
= DÃ©ployer les images prÃ©cÃ©demment compilÃ©es sur un environnement Docker, grÃ¢ce au pipeline de livraison continue. 


Puis, nous lancerons les tests grÃ¢ce Ã  la mÃ©thode **Canary Release**.

Afin de vous faciliter la tÃ¢che et de ne pas installer des dÃ©pendances inutiles, je vous conseille de crÃ©er un environnement sur le siteÂ [Play-With-Docker](https://labs.play-with-docker.com/). 

Ce site va vous permettre de crÃ©er une infrastructure Docker rapidement. 

Rendez-vous sur le site et connectez-vous avec vos identifiants Docker Hub.

Une fois connectÃ©, une session de 4 heures est crÃ©Ã©e afin de vous permettre de dÃ©ployer vos images. 

Sur la page dâ€™accueil, cliquez sur lâ€™icÃ´ne ğŸ”§ et sÃ©lectionnez le template 3 Managers and 2 Workers.

CrÃ©ation de lâ€™environnement de dÃ©ploiement de l'application MatchUp dans Play-with-Docker

Cela va vous crÃ©er un cluster Docker Swarm, nÃ©cessaire au dÃ©ploiement des images. 

Une fois le cluster crÃ©Ã©, vous allez rÃ©cupÃ©rer lâ€™URL de lâ€™environnement. 

Il suffit de copier lâ€™URL prÃ©sente dans la case SSH.

Copiez lâ€™URL SSH de votre Docker Swarm sur le Play-With-Docker

Cette URL sera utilisÃ©e pour configurer lâ€™environnement de dÃ©ploiement dans le fichier .gitlab-ci.yml.

== DÃ©ployez en environnement de prÃ©production

Maintenant que vous avez copiÃ© lâ€™URL de votre Docker Swarm, modifiez ce fichier pour ajouter deux nouvelles lignes. 

La premiÃ¨re ligne Ã  ajouter est au niveau de`variables`. Cette nouvelle variable va contenir lâ€™URL copiÃ©e prÃ©cÃ©demment :

[source, bash]
----
PWD: ip289-38-1-51-dsdshm1
----

=== DeuxiÃ¨me ligne

La deuxiÃ¨me ligne est Ã  ajouter juste aprÃ¨s lâ€™Ã©tape`package`. 

Cette Ã©tape supplÃ©mentaire sera le dÃ©ploiement des images sur un environnement de staging :

[source, yaml]
----
deploy_staging_job:
  stage: deploy
  image: alpine
  script:
    - apk add --no-cache docker-cli-compose
    - export DOCKER_HOST=tcp://$PLAYWD.direct.labs.play-with-docker.com:2375
    - docker compose down
    - docker compose up -d
  environment:
    name: staging
    url: http://$PLAYWD-8080.direct.labs.play-with-docker.com

----



La syntaxe est la mÃªme que les prÃ©cÃ©dentes Ã©tapes. 

Dans la partie script, nous avons ajoutÃ© la copie du fichier`docker-compose.yml`, ainsi que le dossier`docker`. 


Enfin, nous dÃ©marrons le projet grÃ¢ce Ã  Docker Compose.

Le but de dÃ©ployer un environnement de staging est de valider les changements fait dans lâ€™application dans un environnementÂ **isoproduction**, câ€™est-Ã -dire qui rÃ©plique parfaitement les conditions de production des futurs changements. 


Câ€™est pourquoi livrer une mise Ã  jour fonctionnelle grÃ¢ce Ã  des conteneurs est parfait, car le conteneur devient de plus en plus lâ€™artÃ©fact de livraison universel.

De plus, nous pouvons ajouter des tests de bonne santÃ© de lâ€™application dans le fichier docker-compose.yaml avec le mot clÃ© â€œhealthcheckâ€. 


Ces tests servent Ã  savoir si lâ€™application continue de bien fonctionner en exÃ©cutant une commande et en regardant le code de retour de lâ€™application. Si ce code est en erreur, Docker Compose va alors redÃ©marrer le conteneur automatiquement afin que lâ€™application continue de fonctionner normalement.

Certains tests nÃ©cessitent aussi le dÃ©ploiement de lâ€™application avant dâ€™Ãªtre lancÃ©s, comme lesÂ **tests de performance**Â que nous allons implÃ©menter. 


Ces tests servent Ã  prendre des dÃ©cisions basÃ©es sur des mÃ©triques. Dans le cas du test de performance, nous pouvons imaginer un changement important dans lâ€™interface de lâ€™application qui a des impacts sur la performance gÃ©nÃ©rale de lâ€™application. Avec ce genre de test, si les mÃ©triques rÃ©cupÃ©rÃ©es sont trop dÃ©gradÃ©es, nous allons pouvoir prendre une dÃ©cision manuelle avant de pousser lâ€™application en production. Dans le cas dâ€™une dÃ©gradation importante de la performance, il faudra alors ouvrir un nouveau bug de performance et refuser la livraison en production de lâ€™application.

GrÃ¢ce Ã  nos pipelines de livraison continue et nos tests de performance lancÃ©s, nous allons alors pouvoir suivre lâ€™Ã©volution et la correction de ce bug avant quâ€™il nâ€™atteigne des performances acceptables. Nous pourrons alors pousser ces changements manuellement en production grÃ¢ce Ã  notre chaÃ®ne DevOps.

Si tout sâ€™est bien passÃ©, vous devriez voir apparaÃ®tre dans vos environnements (Deployments > Environnements), le nouvel environnementÂ **staging**.


Votre nouvel environnement de staging

Vous pouvez alors cliquer sur le lien "Open" sur la droite de cet environnement, afin de voir lâ€™application dÃ©ployÃ©e.


Votre application dÃ©ployÃ©e